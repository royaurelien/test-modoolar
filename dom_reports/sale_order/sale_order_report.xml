<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="dom_report_saleorder_document">
        <t t-call="dom_reports.external_layout">
            <t t-set="doc" t-value="doc.with_context({'lang':doc.partner_id.lang})" />
            <div class="page">
                <div class="oe_structure"/>


                <t t-set="devis" t-value="doc.state in ['draft','sent']"/>
                <t t-set="bdc" t-value="doc.state not in ['draft','sent']"/>

                <t t-call="dom_reports.upper_part" />

                <!-- table avec les lignes de vente -->

                <!-- Is there a discount on at least one line? -->
                <t t-set="display_discount" t-value="any([l.discount for l in doc.order_line])"/>

                <t t-foreach="doc.order_lines_layouted()" t-as="page">
                    <table class="table-curved lines-table">
                        <thead>
                            <tr>
                                <th>REFERENCE</th>
                                <th>DESIGNATION</th>
                                <th>QTE</th>
                                <th>CONDT</th>
                                <th>P.U HT</th>
                                <th t-if="display_discount">% REM</th>
                                <th>P.U HT NET</th>
                                <th>MONTANT HT</th>
                                <!-- <th class="text-right">TVA</th> -->
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="page" t-as="layout_category">

                                <!-- sections -->
                                <t t-if="layout_category_size > 1 or page_size > 1" groups="sale.group_sale_layout">
                                    <tr class="active">
                                        <td colspan="16" style="font-weight: bold;
                                            border-bottom: 1px solid black;
                                            border-top: 1px solid black;
                                            padding: 5px;">
                                            &amp;bull;
                                            <t t-if="layout_category['name'] == 'Uncategorized'">
                                                <span>Sans catégorie</span>
                                            </t>
                                            <t t-else="" t-esc="layout_category['name']" />
                                        </td>
                                    </tr>
                                </t>

                                <!-- Lignes du devis/bc -->
                                <t t-foreach="layout_category['lines']" t-as="l">
                                    <!-- commentaires
                                    <tr t-if="l.comment_free and l.comment_position == 'before'" class="line-comment">
                                        <td colspan="16">
                                            <t t-raw="l.comment_free" />
                                        </td>
                                    </tr>
                                    <tr t-if="l.comment_predef and l.comment_position == 'before'" class="line-comment">
                                        <td colspan="16">
                                            <t t-raw="l.comment_predef.value" />
                                        </td>
                                    </tr> -->
                                    <t t-if="(not l.is_delivery) and (not l.is_decond) and (not l.product_id.is_comment)">
                                        <tr>
                                            <!--
                                            <td>
                                                page_index : <t t-esc="page_index" />
                                                page_size : <t t-esc="page_size" />
                                                lc_index : <t t-esc="layout_category_index" />
                                                lc_size : <t t-esc="layout_category_size" />
                                                ll_index : <t t-esc="l_index" />
                                                ll_size : <t t-esc="l_size" />
                                            </td> -->
                                            <!-- ref -->
                                            <td class="left-align">
                                                <span t-field="l.product_id.default_code"/>
                                            </td>
                                            <!-- description -->
                                            <td class="left-align">
                                                <span t-field="l.name"/>
                                            </td>
                                            <!-- qte -->
                                            <td>
                                                <!--<span t-field="l.product_uom" groups="product.group_uom"/>-->
                                                <!-- <span t-field="l.product_uom_qty"/> -->
                                                <t t-set="qty" t-value="l.product_uom_qty"/>
                                                <span t-esc="int(qty) if qty.is_integer() else qty"/>
                                            </td>
                                            <!-- condt -->
                                            <td><span t-field="l.product_id.uom_id"/></td>
                                            <!-- P.U HT -->
                                            <td class="right-align">
                                                <span t-field="l.price_unit"/>
                                            </td>
                                            <!-- % REM -->
                                            <td t-if="display_discount" class="right-align">
                                                <span t-field="l.discount"/>
                                            </td>
                                            <!-- P.U HT NET = P.U HT __après remise__-->
                                            <td class="right-align">
                                                <span t-field="l.price_reduce"
                                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                            </td>
                                            <!-- MONTANT HT = MONTANT TOTAL LIGNE HT -->
                                            <!-- montant ht avec remise * nbre d'unités -->
                                            <td class="right-align">
                                                <!-- <span t-field="l.price_subtotal" -->
                                                <span t-field="l.price_subtotal_net"
                                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                            </td>
                                            <!-- % TVA (taxes) -->
                                            <!--
                                            <td class="text-right" style="white-space: nowrap;">
                                                <span t-esc="', '.join(map(lambda x: str(int(x.amount)) if x.amount.is_integer() else str(x.amount), l.tax_id))"/>%
                                            </td>
                                            -->
                                            <!--
                                            <span t-field="l.tax_id.amount"
                                                t-options='{"widget": "float", "precision": 1}'/> % -->
                                        </tr>
                                    </t>

                                    <t t-if="l.product_id.is_comment">
                                        <tr>
                                            <td colspan="12" class="line_comment">
                                                <p style="margin:0;"> <span t-field="l.name" /> </p>
                                            </td>
                                        </tr>
                                    </t>

                                    <!-- commentaires
                                    <tr t-if="l.comment_free and l.comment_position == 'after'" class="line-comment">
                                        <td colspan="16">
                                            <t t-raw="l.comment_free" />
                                        </td>
                                    </tr>
                                    <tr t-if="l.comment_predef and l.comment_position == 'after'" class="line-comment">
                                        <td colspan="16">
                                            <t t-raw="l.comment_predef.value" />
                                        </td>
                                    </tr> -->

                                </t>

                                <!-- subtotal part
                                <t t-if="(layout_category_size > 1 or page_size > 1) and layout_category['subtotal']" groups="sale.group_sale_layout">
                                    <tr class="text-right">
                                        <td colspan="6">
                                            <strong>Subtotal: </strong>
                                            <t t-set="subtotal" t-value="sum(line.price_subtotal for line in layout_category['lines'])"/>
                                            <span t-esc="subtotal" t-options="{'widget': 'monetary', 'display_currency': doc.pricelist_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </t>
                                -->

                            </t> <!-- lines foreach end -->
                        </tbody>
                    </table>

                    <!--Champs des CGV pour mettre des commentaires-->
                    <p t-field="doc.note" />
                    <!--
                    <p t-if="doc.payment_term_id.note">
                        <span t-field="doc.payment_term_id.note"/>
                    </p> -->

                    <t t-if="page_index &lt; page_size - 1" groups="sale.group_sale_layout">
                        <p style="page-break-before:always;"> </p>
                    </t>

                    <!--
                    <t t-if="page_index == 0">
                        <script>
                            console.log('DURPPP');
                            // var ltr = $("#lt").find('tbody').children().last()
                            // $(ltr).css('background-color', 'red');

                            var lt = document.getElementById('lt');
                            lt.style.backgroundColor = "red";

                            debugger;
                        </script>
                    </t>
                    -->

                </t> <!-- PAGE foreach end -->

                <!-- SUMMARY TABLE SO/BC -->
                <!-- bases ht / remise / port ht / deconditionnement / TOTAL HT NET / % TVA / MT TVA / TOTAUX / Net à Payer  -->
                <table class="table-curved summary-table">
                    <thead>
                        <tr>
                            <!--<th>BASES HT</th>-->
                            <th t-if="doc.remise.amount">REMISE</th>
                            <th>PORT HT</th>
                            <th style="white-space: normal;">
                                DECONDITIONNEMENT
                            </th>
                            <th>TOTAL HT NET</th>
                            <th>% TVA</th>
                            <th>MT TVA</th>
                            <th>TOTAUX</th>
                            <th>Net à Payer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <!-- BASES HT
                            <td style="white-space: nowrap;">
                                <t t-set="tax_groups_length" t-value="len(doc._get_tax_amount_by_group())"/>
                                <t t-foreach="doc._get_tax_amount_by_group()" t-as="amount_by_group">
                                    <span t-esc="amount_by_group[0]"/><span>&amp;nbsp;<span>sur</span>&amp;nbsp;<t t-esc="amount_by_group[2]" t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/></span>
                                    <br/>
                                </t>
                            </td> -->

                            <!-- remise globale -->
                            <td t-if="doc.remise">
                                <span t-esc="str(int(doc.remise.amount)) if doc.remise.amount.is_integer() else str(doc.remise.amount)" />%
                                <br/>
                                <!-- valeur remise globale -->
                                <span t-esc="doc.amount_ht_net*(doc.remise.amount/100)"
                                      t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                            </td>
                            <!-- port -->
                            <td>
                                <t t-foreach="doc.order_line" t-as="l">
                                    <t t-if="l.is_delivery">
                                        <span t-field="l.price_subtotal_net"
                                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                    </t>
                                </t>
                            </td>
                            <td>
                                <t t-foreach="doc.order_line" t-as="l">
                                    <t t-if="l.is_decond">
                                        <span t-field="l.price_subtotal_net"
                                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                    </t>
                                </t>
                            </td>

                            <!-- TOTAL HT NET -->
                            <td>
                                <span t-field="doc.amount_ht_net"
                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                            </td>

                            <!-- taxes.. ??? -->
                            <td>
                                <t t-foreach="doc._get_tax_amount_by_group()" t-as="amount_by_group">
                                    <span t-esc="amount_by_group[0]" />
                                </t>
                            </td>

                            <!-- montant tva -->
                            <td>
                                <span t-field="doc.amount_tax"
                                      t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                            </td>
                            <!-- <td style="white-space: nowrap;"> -->
                            <td>
                                H.T. :
                                <span t-field="doc.amount_untaxed"
                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                <br/>
                                T.V.A. :
                                <span t-field="doc.amount_tax"
                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                <br/>
                            </td>
                            <td>
                                <span t-field="doc.amount_total"
                                      t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div> <!-- page div -->
        </t> <!-- external layout t -->

    </template>

    <!-- ids used by actions -->
    <template id="dom_report_saleorder">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="dom_reports.dom_report_saleorder_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

    <template id="dom_report_saleorder_pro_forma">
        <t t-call="web.html_container">
            <t t-set="is_pro_forma" t-value="True"/>
            <t t-foreach="docs" t-as="doc">
                <t t-call="dom_reports.dom_report_saleorder_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

</odoo>
