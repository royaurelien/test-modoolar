<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
        <t t-extend="mail.activity_items" t-name="mail.activity_items">
            <t t-jquery="div[class='o_thread_message']" t-operation="replace">
                <t t-if="activity.archived != true">
                    <div class="o_thread_message" style="margin-bottom: 10px">
                        <div class="o_thread_message_sidebar">
                            <div class="o_avatar_stack">
                                <img t-attf-src="/web/image#{activity.user_id[0] >= 0 ? ('/res.users/' + activity.user_id[0] + '/image_small') : ''}" class="o_thread_message_avatar img-circle mb8" t-att-title="activity.create_uid[1]"/>
                                <i t-att-class="'o_avatar_icon fa ' + activity.icon + ' bg-' + (activity.state == 'planned'? 'success' : (activity.state == 'today'? 'warning' : 'danger')) + '-full'"
                                   t-att-title="activity.activity_type_id[1]"/>
                            </div>
                        </div>
                        <div class="o_thread_message_core">
                            <div class="o_mail_info">
                                <strong><span t-attf-class="o_activity_date o_activity_color_#{activity.state}"><t t-esc="activity.label_delay" /></span></strong>:
                                <strong t-if="activity.summary"> &#8220;<t t-esc="activity.summary"/>&#8221;</strong>
                                <strong t-if="!activity.summary"> <t t-esc="activity.activity_type_id[1]" /></strong>
                                <em> for </em>
                                <t t-esc="activity.user_id[1]" />
                                <a class="btn btn-link btn-info text-muted collapsed o_activity_info ml4" role="button" data-toggle="collapse" t-attf-data-target="#o_chatter_activity_info_#{activity.id}">
                                    <i class="fa fa-info-circle"></i>
                                </a>
                                <div class="o_thread_message_collapse collapse" t-attf-id="o_chatter_activity_info_#{activity.id}">
                                    <dl class="dl-horizontal well">
                                        <dt>Activity type</dt>
                                        <dd class="mb8">
                                            <t t-esc="activity.activity_type_id[1]"/>
                                        </dd>
                                        <dt>Created By</dt>
                                        <dd class="mb8">
                                            <img t-attf-src="/web/image#{activity.create_uid[0] >= 0 ? ('/res.users/' + activity.create_uid[0] + '/image_small') : ''}" height="18" width="18" class="img-circle mr4" t-att-title="activity.create_uid[1]"/>
                                            <b><t t-esc="activity.create_uid[1]"/></b>
                                            <em>, on</em> <t t-esc="moment(activity.create_date)"/>
                                        </dd>
                                        <dt>Assigned to</dt>
                                        <dd class="mb8">
                                            <img t-attf-src="/web/image#{activity.user_id[0] >= 0 ? ('/res.users/' + activity.user_id[0] + '/image_small') : ''}" height="18" width="18" class="img-circle mr4" t-att-title="activity.create_uid[1]"/>
                                            <b><t t-esc="activity.user_id[1]"/></b>
                                            <em>, due on </em><span t-attf-class="o_activity_color_#{activity.state}"><t t-esc="moment(activity.date_deadline)"/></span>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div t-if="activity.note" class="o_thread_message_note small">
                                <t t-raw="activity.note"/>
                            </div>
                            <div class="o_thread_message_tools btn-group">
                                <a href="#" class="btn btn-link btn-success text-muted btn-sm o_activity_done o_activity_link mr8" t-att-data-activity-id="activity.id" t-att-data-previous-activity-type-id="activity.activity_type_id[0]" data-toggle="popover">
                                    <i class="fa fa-check"/> Mark Done
                                </a>
                                <a href="#" class="btn btn-link btn-default text-muted btn-sm o_activity_edit o_activity_link" t-att-data-activity-id="activity.id">
                                    <i class="fa fa-pencil"/> Edit
                                </a>
                                <a href="#" class="btn btn-link btn-sm btn-danger text-muted o_activity_unlink o_activity_link" t-att-data-activity-id="activity.id">
                                    <i class="fa fa-times"/> Cancel
                                </a>
                            </div>
                        </div>
                    </div>
                </t>
            </t>

            <t t-jquery="div[class='o_thread_date_separator o_border_dashed']" t-operation="replace">
                <t t-set="all_archived" t-value="true"/>
                <t t-set="planned_to_remove" t-value="0"/>
                <t t-set="today_to_remove" t-value="0"/>
                <t t-set="overdue_to_remove" t-value="0"/>

                <t t-foreach="activities" t-as="activity">
                    <t t-if="activity.archived != true">
                        <t t-set="all_archived" t-value="false"/>
                    </t>

                    <t t-if="activity.archived == true">
                        <t t-if="activity.state == 'planned'">
                            <t t-set="planned_to_remove" t-value="planned_to_remove+1"/>
                        </t>
                        <t t-if="activity.state == 'today'">
                            <t t-set="today_to_remove" t-value="today_to_remove+1"/>
                        </t>
                        <t t-if="activity.state == 'overdue'">
                            <t t-set="overdue_to_remove" t-value="overdue_to_remove+1"/>
                        </t>
                    </t>
                </t>

                <t t-if="nbOverdueActivities">
                    <t t-set="nbOverdueActivities" t-value="nbOverdueActivities-overdue_to_remove"/>
                </t>
                <t t-if="nbTodayActivities">
                    <t t-set="nbTodayActivities" t-value="nbTodayActivities-today_to_remove"/>
                </t>
                <t t-if="nbPlannedActivities">
                    <t t-set="nbPlannedActivities" t-value="nbPlannedActivities-planned_to_remove"/>
                </t>

                <t t-if="all_archived == false">
                    <div class="o_thread_date_separator o_border_dashed" data-toggle="collapse" data-target="#o_chatter_planned_activities">
                        <span class="o_thread_date btn">
                            <i class="fa fa-fw fa-caret-down"/>
                            Planned activities
                            <small class="o_chatter_planned_activities_summary ml8">
                                <span class="label img-circle label-danger" t-if="nbOverdueActivities !=0"><t t-esc="nbOverdueActivities"/></span>
                                <span class="label img-circle label-warning" t-if="nbTodayActivities !=0"><t t-esc="nbTodayActivities"/></span>
                                <span class="label img-circle label-success" t-if="nbPlannedActivities !=0"><t t-esc="nbPlannedActivities"/></span>
                            </small>
                        </span>
                    </div>
                </t>
            </t>
        </t>
</odoo>