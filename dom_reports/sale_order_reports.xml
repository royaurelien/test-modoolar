<odoo>

    <template id="dom_report_saleorder_document">
        <t t-call="dom_reports.external_layout">
            <t t-set="doc" t-value="doc.with_context({'lang':doc.partner_id.lang})" />
            <div class="page">
                <div class="oe_structure"/>


                <t t-set="devis" t-value="doc.state in ['draft','sent']"/>
                <t t-set="bdc" t-value="doc.state not in ['draft','sent']"/>

                <t t-call="dom_reports.upper_part" />

                <!-- table avec les lignes de vente -->

                <!-- Is there a discount on at least one line? -->
                <t t-set="display_discount" t-value="any([l.discount for l in doc.order_line])"/>

                <t t-foreach="doc.order_lines_layouted()" t-as="page">
                    <table class="lines-table" id="lt">
                        <thead>
                            <tr>
                                <th>REFERENCE</th>
                                <th>DESIGNATION</th>
                                <th class="text-right">QTE</th>
                                <th class="text-right">CONDT</th>
                                <th class="text-right">P.U HT</th>
                                <th t-if="display_discount"
                                    class="text-right"
                                    groups="sale.group_discount_per_so_line">% REM</th>
                                <th class="text-right"
                                    groups="sale.group_show_price_subtotal">P.U HT NET</th>
                                <th class="text-right price_tax_included"
                                    groups="sale.group_show_price_total">MONTANT HT</th>
                                <th class="text-right">TVA</th>
                            </tr>
                        </thead>
                        <tbody class="sale_tbody">
                            <t t-foreach="page" t-as="layout_category">

                                <t t-if="layout_category_size > 1 or page_size > 1" groups="sale.group_sale_layout">
                                    <tr class="active">
                                        <td colspan="7" style="font-weight: bold; border-bottom: 1px solid black;">&amp;bull;
                                            <t t-esc="layout_category['name']"/>
                                        </td>
                                    </tr>
                                </t>

                                <!-- Lines associated -->
                                <t t-foreach="layout_category['lines']" t-as="l">
                                    <tr>
                                        <!--
                                        <td>
                                            page_index : <t t-esc="page_index" />
                                            page_size : <t t-esc="page_size" />
                                            lc_index : <t t-esc="layout_category_index" />
                                            lc_size : <t t-esc="layout_category_size" />
                                            ll_index : <t t-esc="l_index" />
                                            ll_size : <t t-esc="l_size" />
                                        </td> -->
                                        <!-- ref -->
                                        <td><span t-field="l.product_id.default_code"/></td>
                                        <!-- description -->
                                        <td><span t-field="l.name"/></td>
                                        <!-- qte -->
                                        <td class="text-right">
                                            <span t-field="l.product_uom_qty"/>
                                            <span t-field="l.product_uom" groups="product.group_uom"/>
                                        </td>
                                        <!-- condt -->
                                        <td><span t-field="l.product_id.uom_id"/></td>
                                        <!-- P.U HT -->
                                        <td class="text-right">
                                            <span t-field="l.price_unit"/>
                                        </td>
                                        <!-- % REM -->
                                        <td t-if="display_discount" class="text-right" groups="sale.group_discount_per_so_line">
                                            <span t-field="l.discount"/>
                                        </td>
                                        <!-- P.U HT NET = P.U HT __après remise__-->
                                        <td class="text-right" groups="sale.group_show_price_subtotal">
                                            <span t-field="l.price_subtotal"
                                                t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                        </td>
                                        <!-- MONTANT HT = MONTANT TOTAL LIGNE HT -->
                                        <td class="text-right" groups="sale.group_show_price_total">
                                            <span t-field="l.price_total"
                                                t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                        </td>
                                        <!-- % TVA (taxes) -->
                                        <td class="text-right" style="white-space: nowrap;">
                                            <!-- <span t-esc="', '.join(map(lambda x: (x.description or x.name), l.tax_id))"/> -->
                                            <span t-esc="', '.join(map(lambda x: str(int(x.amount)) if x.amount.is_integer() else str(x.amount), l.tax_id))"/>%
                                            <!--
                                            <span t-field="l.tax_id.amount"
                                                t-options='{"widget": "float", "precision": 1}'/> % -->
                                        </td>
                                    </tr>
                                </t>

                                <t t-if="(layout_category_size > 1 or page_size > 1) and layout_category['subtotal']" groups="sale.group_sale_layout">
                                    <tr class="text-right">
                                        <td colspan="6">
                                            <strong>Subtotal: </strong>
                                            <t t-set="subtotal" t-value="sum(line.price_subtotal for line in layout_category['lines'])"/>
                                            <span t-esc="subtotal" t-options="{'widget': 'monetary', 'display_currency': doc.pricelist_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </t>

                            </t> <!-- lines foreach end -->
                        </tbody>
                    </table>

                    <!--
                    <p> ya </p>
                    <t t-esc="page_index" />
                    <p> ye </p>
                    <t t-esc="page_size" />
                    <p> yi </p>
                    -->

                    <t t-if="page_index &lt; page_size - 1" groups="sale.group_sale_layout">
                        <p style="page-break-before:always;"> </p>
                    </t>

                    <!--
                    <t t-if="page_index == 0">
                        <script>
                            console.log('DURPPP');
                            // var ltr = $("#lt").find('tbody').children().last()
                            // $(ltr).css('background-color', 'red');

                            var lt = document.getElementById('lt');
                            lt.style.backgroundColor = "red";

                            debugger;
                        </script>
                    </t>
                    -->

                </t> <!-- PAGE foreach end -->

                    <!-- bases ht / remise / port ht / deconditionnement / TOTAL HT NET / % TVA / MT TVA / TOTAUX / Net à Payer  -->

                    <table class="rounded-table">
                        <thead>
                            <tr>
                                <th>BASES HT</th>
                                <th>REMISE</th>
                                <th>PORT HT</th>
                                <th style="white-space: normal;">
                                    DECONDIT IONNEMENT
                                </th>
                                <th>TOTAL HT NET</th>
                                <th>% TVA</th>
                                <th>MT TVA</th>
                                <th>TOTAUX</th>
                                <th>Net à Payer</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="white-space: nowrap;">
                                <!-- td -->
                                    <t t-set="tax_groups_length" t-value="len(doc._get_tax_amount_by_group())"/>
                                    <t t-foreach="doc._get_tax_amount_by_group()" t-as="amount_by_group">
                                        <t t-if="amount_by_group[3] == 1 and doc.amount_untaxed == amount_by_group[2]">
                                                <span t-esc="amount_by_group[0]"/>
                                                <!-- montant de la tva ajouté au prix ht remisé
                                                <span t-esc="amount_by_group[1]"
                                                    t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                                -->
                                        </t>
                                        <t t-else ="">
                                                <span t-esc="amount_by_group[0]"/><span>&amp;nbsp;<span>sur</span>&amp;nbsp;<t t-esc="amount_by_group[2]" t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/></span>
                                                <!-- montant de la tva ajouté au prix ht remisé
                                                <span t-esc="amount_by_group[1]"
                                                    t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                                -->
                                         </t>
                                        <br/>
                                    </t>
                                </td>

                                <td> valeur remise </td>
                                <td> valeur port ht </td>
                                <td> valeur decond. </td>
                                <td>
                                    <span t-field="doc.amount_untaxed"
                                        t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                </td>
                                <td> % tva val </td>
                                <td> mt tva val </td>
                                <!-- <td style="white-space: nowrap;"> -->
                                <td>
                                    H.T. :
                                    <span t-field="doc.amount_untaxed"
                                        t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                    <br/>
                                    T.V.A. :
                                    <span t-field="doc.amount_tax"
                                        t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                    <br/>
                                </td>
                                <td>
                                    <span t-field="doc.amount_total"
                                        t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}'/>
                                </td>
                            </tr>
                        </tbody>
                    </table>

            </div> <!-- page div -->
        </t> <!-- external layout t -->

    </template>


    <!-- ids used by actions -->
    <template id="dom_report_saleorder">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="dom_reports.dom_report_saleorder_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

    <template id="dom_report_saleorder_pro_forma">
        <t t-call="web.html_container">
            <t t-set="is_pro_forma" t-value="True"/>
            <t t-foreach="docs" t-as="doc">
                <t t-call="dom_reports.dom_report_saleorder_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

</odoo>
